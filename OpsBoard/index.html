<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ops Display Board – Weather & NOTAMs</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111a2b;
      --panel-2: #0f1726;
      --text: #e8eef9;
      --muted: #a9b4c7;
      --accent: #79c0ff;
      --good: #2fbf71;
      --warn: #f0b429;
      --bad: #f05454;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #0a1020 60%);
      color: var(--text);
    }
    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 16px;
      grid-template-columns: 1.2fr 1fr;
      grid-template-areas:
        "hero side"
        "metar side"
        "notam tests"
        "xml tests";
    }
    @media (max-width: 1100px) {
      .wrap {
        grid-template-columns: 1fr;
        grid-template-areas:
          "hero"
          "side"
          "metar"
          "notam"
          "xml"
          "tests";
      }
    }
    .panel { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); overflow: hidden; }
    .panel h2 { margin: 0; padding: 12px 16px; font-size: 18px; letter-spacing: 0.2px; border-bottom: 1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.03); }
    .hero { grid-area: hero; min-height: 380px; display: flex; flex-direction: column; }
    .hero .content { flex: 1; }
    .iframe-box { position: relative; width: 100%; height: 100%; min-height: 300px; }
    .iframe-box iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: 0; }
    .side { grid-area: side; display: grid; gap: 16px; }
    .metar { grid-area: metar; }
    .table-wrap { overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.06); }
    th { position: sticky; top: 0; background: rgba(15,23,38,0.9); backdrop-filter: blur(6px); font-weight: 600; }
    tr:hover td { background: rgba(255,255,255,0.03); }
    .pill { padding: 3px 8px; border-radius: 999px; font-size: 12px; display: inline-block; }
    .vfr { background: rgba(47,191,113,0.15); color: var(--good); border: 1px solid rgba(47,191,113,0.35); }
    .mvfr { background: rgba(240,180,41,0.15); color: var(--warn); border: 1px solid rgba(240,180,41,0.35); }
    .ifr { background: rgba(240,84,84,0.15); color: var(--bad); border: 1px solid rgba(240,84,84,0.35); }
    .lifr { background: rgba(130,84,240,0.15); color: #c69cff; border: 1px solid rgba(130,84,240,0.35); }
    .notam { grid-area: notam; }
    details { border-bottom: 1px solid rgba(255,255,255,0.08); }
    details > summary { cursor: pointer; padding: 12px 16px; list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
    details[open] > summary { background: rgba(255,255,255,0.03); }
    .notam-body { padding: 0 16px 12px 16px; white-space: pre-wrap; color: var(--muted); }
    .bar { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 8px 12px; font-size: 13px; color: var(--muted); }
    .bar button { background: #1b2944; color: var(--text); border: 1px solid rgba(255,255,255,0.08); padding: 8px 12px; border-radius: 10px; cursor: pointer; }
    .bar button:hover { background: #223155; }
    .tests { grid-area: tests; }
    .xml { grid-area: xml; }
    pre { margin: 0; padding: 12px 16px; overflow: auto; white-space: pre-wrap; word-break: break-word; }
    .test-pass { color: var(--good); }
    .test-fail { color: var(--bad); }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="panel hero">
      <h2>WeatherStar Live</h2>
      <div class="content iframe-box">
        <iframe src="https://weatherstar.bnttech.me/index.html?hazards-checkbox=false&current-weather-checkbox=true&latest-observations-checkbox=true&hourly-checkbox=true&hourly-graph-checkbox=true&travel-checkbox=false&regional-forecast-checkbox=true&local-forecast-checkbox=true&extended-forecast-checkbox=true&almanac-checkbox=true&spc-outlook-checkbox=true&radar-checkbox=true&settings-wide-checkbox=true&settings-kiosk-checkbox=true&settings-stickyKiosk-checkbox=false&settings-scanLines-checkbox=false&settings-customFeedEnable-checkbox=false&settings-speed-select=1.00&settings-scanLineMode-select=auto&settings-units-select=us&settings-mediaVolume-select=0.25&txtLocation=%22Fort+Hood+TX+USA%22&settings-customFeed-string=&share-link-url=&latLonQuery=76544%2C+Fort+Hood%2C+TX%2C+USA&latLon=%7B%22lat%22%3A31.136%2C%22lon%22%3A-97.779%7D?settings-mediaPlaying-boolean=true" title="WeatherStar"></iframe>
      </div>
      <div class="bar">
        <div>Focus KHLR. Auto refresh 5 minutes. Data direct to AWC API.</div>
        <div><button id="refreshBtn" title="Refresh now">Refresh</button></div>
      </div>
    </section>

    <aside class="side">
      <section class="panel" style="min-height:200px">
        <h2>Quick Status</h2>
        <div id="quick" style="padding:12px 16px; font-size:14px; color:var(--muted)">Loading station and NOTAM status.</div>
      </section>
      <section class="panel" style="min-height:200px">
        <h2>Clock</h2>
        <div id="clock" style="padding:16px; font-size:32px; font-variant-numeric: tabular-nums"></div>
      </section>
    </aside>

    <section class="panel metar">
      <h2>METARs – KHLR plus 10 within 50 NM</h2>
      <div class="table-wrap">
        <table id="metarTable" aria-label="METAR table">
          <thead>
            <tr>
              <th>ICAO</th>
              <th>Distance NM</th>
              <th>Time (Z)</th>
              <th>Flight</th>
              <th>Wind</th>
              <th>Vis</th>
              <th>Ceiling</th>
              <th>Temp/Dew</th>
              <th>Alt</th>
              <th>METAR</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="bar"><span id="metarStatus">Loading METARs.</span></div>
    </section>

    <section class="panel notam">
      <h2>NOTAMs – KHLR</h2>
      <div id="notams"></div>
      <div class="bar"><span id="notamStatus">Loading NOTAMs.</span></div>
    </section>

    <section class="panel xml">
      <h2>XML Debug – Current METAR KHLR</h2>
      <div class="bar">
        <div>Source. https://aviationweather.gov/cgi-bin/data/dataserver.php?dataSource=metars&requestType=retrieve&stationString=KHLR&format=XML</div>
        <div>
          <button id="xmlBtn" title="Fetch XML now">Fetch XML</button>
        </div>
      </div>
      <pre id="xmlOut">Press Fetch XML to request the current METAR for KHLR in XML format.</pre>
    </section>

    <section class="panel tests">
      <h2>Diagnostics</h2>
      <div id="diag" style="padding:12px 16px; color:var(--muted)">Running self tests.</div>
      <div class="table-wrap">
        <table id="testTable">
          <thead><tr><th>Test</th><th>Result</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // Direct AWC endpoints per your request
    const AWC_BASE = "https://aviationweather.gov";
    const AWC_PATH = "/api/data"; // /airport, /metar

    const state = {
      khlr: { icao: "KHLR", lat: null, lon: null },
      metars: [],
      notams: []
    };

    function fmtZulu(dtStr) {
      if (!dtStr) return "";
      const d = new Date(dtStr);
      return d.toISOString().replace("T", " ").replace(":00.000Z", "Z");
    }

    function toRad(x) { return x * Math.PI / 180; }
    function haversineNM(lat1, lon1, lat2, lon2) {
      const Rnm = 3440.065;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return Rnm * c;
    }

    function flightCat(row) {
      const fc = row.fltCat || row.flight_category || "";
      const cls = fc === "VFR" ? "vfr" : fc === "MVFR" ? "mvfr" : fc === "IFR" ? "ifr" : fc === "LIFR" ? "lifr" : "";
      return `<span class="pill ${cls}">${fc || ""}</span>`;
    }

    function ceiling(row) {
      const clouds = row.clouds || row.sky_condition || [];
      const layers = Array.isArray(clouds) ? clouds : [clouds];
      const getCover = c => c.cover || c["@_sky_cover"];
      const getBase = c => c.base || parseInt(c["@_cloud_base_ft_agl"]) || null;
      const bknOvc = layers.filter(l => ["BKN","OVC","OVX"].includes(getCover(l)))
                           .map(getBase).filter(v => Number.isFinite(v));
      if (!bknOvc.length) return "";
      return `${Math.min(...bknOvc)} ft`;
    }

    function windStr(row) {
      const dir = row.windDir ?? row.wind_dir_degrees;
      const spd = row.windSpeedKt ?? row.wind_speed_kt;
      const gst = row.windGustKt ?? row.wind_gust_kt;
      if (dir == null || spd == null) return "";
      return `${String(dir).padStart(3, "0")}@${spd}kt${gst ? ` G${gst}` : ""}`;
    }

    function tempDew(row) {
      const t = row.temp ?? row.temp_c;
      const d = row.dewpoint ?? row.dewpoint_c;
      if (t == null) return "";
      return `${t}C${d != null ? `/${d}C` : ""}`;
    }

    function altim(row) {
      const a = row.altimHg ?? row.altim_in_hg;
      return a != null ? `${a} inHg` : "";
    }

    async function fetchJSON(url) {
      const r = await fetch(url, { cache: "no-store", headers: { "x-user-agent": "ops-display/1.0" } });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function fetchText(url) {
      const r = await fetch(url, { cache: "no-store", headers: { "x-user-agent": "ops-display/1.0" } });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.text();
    }

    async function loadKHLRStation() {
      const url = `${AWC_BASE}${AWC_PATH}/airport?ids=KHLR&format=json`;
      const j = await fetchJSON(url);
      const s = j?.data?.[0];
      if (!s) throw new Error("KHLR airport not found");
      state.khlr.lat = parseFloat(s.lat);
      state.khlr.lon = parseFloat(s.lon);
      return state.khlr;
    }

    async function loadMETARs() {
      const lat = state.khlr.lat; const lon = state.khlr.lon;
      // bbox order: lon_min,lat_min,lon_max,lat_max
      const dLat = 50 / 60; // deg per 50 NM
      const dLon = 50 / (60 * Math.cos(toRad(lat)));
      const box = `${(lon - dLon).toFixed(4)},${(lat - dLat).toFixed(4)},${(lon + dLon).toFixed(4)},${(lat + dLat).toFixed(4)}`;

      const url = `${AWC_BASE}${AWC_PATH}/metar?bbox=${box}&hours=3&format=json`;
      const j = await fetchJSON(url);
      let arr = j?.data || [];

      const hasKHLR = arr.some(m => (m.icaoId||m.station||m.stationId) === 'KHLR');
      if (!hasKHLR) {
        try {
          const kurl = `${AWC_BASE}${AWC_PATH}/metar?ids=KHLR&hours=6&format=json`;
          const kj = await fetchJSON(kurl);
          if (Array.isArray(kj?.data) && kj.data.length) arr.push(...kj.data);
        } catch (_) {}
      }

      const byIcao = new Map();
      for (const m of arr) {
        const icao = m.icaoId || m.station || m.id || m.stationId;
        if (!icao) continue;
        const la = parseFloat(m.lat ?? m.latitude ?? m.latDegrees);
        const lo = parseFloat(m.lon ?? m.longitude ?? m.lonDegrees);
        const dist = Number.isFinite(la) && Number.isFinite(lo) ? haversineNM(state.khlr.lat, state.khlr.lon, la, lo) : 9999;
        m._dist_nm = dist;
        const t = Date.parse(m.obsTime || m.time || m.observed || m.issueTime || 0);
        const prev = byIcao.get(icao);
        if (!prev || Date.parse(prev.obsTime || prev.time || prev.observed || prev.issueTime || 0) < t) byIcao.set(icao, m);
      }

      const list = Array.from(byIcao.values())
        .filter(m => m._dist_nm <= 50.5)
        .sort((a,b) => ((a.icaoId||a.stationId||a.station)==='KHLR' ? -1 : ((b.icaoId||b.stationId||b.station)==='KHLR' ? 1 : a._dist_nm - b._dist_nm)));

      const picked = [];
      const others = [];
      for (const m of list) {
        const id = m.icaoId || m.station || m.id || m.stationId;
        if (id === 'KHLR') picked.push(m); else others.push(m);
      }
      picked.push(...others.slice(0, 10));

      state.metars = picked;
    }

    function renderMETARs() {
      const tbody = document.querySelector('#metarTable tbody');
      tbody.innerHTML = '';
      for (const m of state.metars) {
        const id = m.icaoId || m.station || m.id || m.stationId || '';
        const t = new Date(m.obsTime || m.time || m.observed || m.issueTime || '');
        const vis = m.visibility ?? m.visibility_statute_mi;
        const visStr = vis != null ? `${vis} SM` : '';
        const raw = m.rawOb ?? m.raw_text ?? '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${id}</strong></td>
          <td>${m._dist_nm ? m._dist_nm.toFixed(1) : ''}</td>
          <td>${isFinite(t.getTime()) ? t.toISOString().slice(11,16)+'Z' : ''}</td>
          <td>${flightCat(m)}</td>
          <td>${windStr(m)}</td>
          <td>${visStr}</td>
          <td>${ceiling(m) || ''}</td>
          <td>${tempDew(m)}</td>
          <td>${altim(m)}</td>
          <td title="${raw}">${raw.slice(0,64)}${raw.length>64?'…':''}</td>`;
        tbody.appendChild(tr);
      }
      document.getElementById('metarStatus').textContent = `Loaded ${state.metars.length} reports.`;
    }

    async function loadNOTAMs() {
      const url = `/faa/notams?location=KHLR`;
      const j = await fetchJSON(url);
      const arr = j?.notams || j?.data || j || [];
      arr.sort((a,b) => Date.parse(b.issued || b.issue_date || 0) - Date.parse(a.issued || a.issue_date || 0));
      state.notams = arr;
    }

    function renderNOTAMs() {
      const box = document.getElementById('notams');
      box.innerHTML = '';
      if (!state.notams.length) {
        document.getElementById('notamStatus').textContent = 'No NOTAMs found.';
        return;
      }
      for (const n of state.notams) {
        const id = n.number || n.notam_id || n.notam_number || 'NOTAM';
        const details = document.createElement('details');
        const summary = document.createElement('summary');
        const issued = fmtZulu(n.issued || n.issue_date);
        const endt = fmtZulu(n.end || n.end_date_time || n.expiration);
        summary.textContent = `${id}  Issued ${issued}${endt?`  Ends ${endt}`:''}`;
        const body = document.createElement('div');
        body.className = 'notam-body';
        body.textContent = n.text || n.all || n.notam_text || JSON.stringify(n, null, 2);
        details.appendChild(summary);
        details.appendChild(body);
        box.appendChild(details);
      }
      document.getElementById('notamStatus').textContent = `Loaded ${state.notams.length} NOTAMs.`;
    }

    function renderQuick() {
      const near = state.metars.filter(x => (x.icaoId||x.stationId||x.station) !== 'KHLR').slice(0,3).map(x => x.icaoId||x.stationId||x.station).join(', ');
      const notamCount = state.notams.length;
      document.getElementById('quick').textContent = `KHLR at ${new Date().toUTCString()}. Nearby: ${near}. NOTAMs: ${notamCount}.`;
    }

    async function refreshAll() {
      try {
        document.getElementById('metarStatus').textContent = 'Loading METARs.';
        document.getElementById('notamStatus').textContent = 'Loading NOTAMs.';
        await loadKHLRStation();
        await loadMETARs();
        renderMETARs();
        await loadNOTAMs();
        renderNOTAMs();
        renderQuick();
      } catch (e) {
        let msg = `Error loading data. ${e.message}`;
        console.error('WX fetch failed', { msg: e.message });
        if (e.message.includes('204')) msg += ' No recent METARs returned for query.';
        document.getElementById('metarStatus').textContent = msg;
      }
    }

    function startClock() {
      const el = document.getElementById('clock');
      function tick() {
        const now = new Date();
        const z = now.toISOString().slice(11,19) + ' Z';
        el.textContent = z;
      }
      tick();
      setInterval(tick, 1000);
    }

    // Test harness
    function addTest(name, pass, detail='') {
      const tbody = document.querySelector('#testTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td class="${pass?'test-pass':'test-fail'}">${pass?'PASS':'FAIL'} ${detail?`- ${detail}:`:''}</td>`;
      tbody.appendChild(tr);
    }

    function runTests() {
      document.querySelector('#testTable tbody').innerHTML = '';
      try {
        const d = haversineNM(0,0,1,0); // ~60 NM per degree lat
        addTest('haversine 1° lat', Math.abs(d - 60) < 2, `got ${d.toFixed(2)}`);
      } catch (e) { addTest('haversine throws', false, e.message); }

      try {
        const fc = flightCat({ fltCat: 'VFR' });
        addTest('flightCat VFR tag', /class="pill vfr">VFR<\/span>/.test(fc), fc);
      } catch (e) { addTest('flightCat throws', false, e.message); }

      try {
        const c = ceiling({ clouds: [ { cover: 'FEW', base: 3000 }, { cover: 'BKN', base: 2000 } ] });
        addTest('ceiling BKN 2000', c === '2000 ft', c);
      } catch (e) { addTest('ceiling throws', false, e.message); }

      try {
        const w = windStr({ windDir: 90, windSpeedKt: 12, windGustKt: 18 });
        addTest('wind string', w === '090@12kt G18', w);
      } catch (e) { addTest('windStr throws', false, e.message); }

      try {
        const td = tempDew({ temp: 22, dewpoint: 18 });
        addTest('temp/dew', td === '22C/18C', td);
      } catch (e) { addTest('tempDew throws', false, e.message); }

      try {
        const a = altim({ altimHg: 29.92 });
        addTest('altimeter', a === '29.92 inHg', a);
      } catch (e) { addTest('altim throws', false, e.message); }

      try {
        const xmlUrl = addsUrl({ dataSource: 'metars', requestType: 'retrieve', stationString: 'KHLR', format: 'XML' });
        addTest('ADDS XML URL', /dataserver\.php\?.*dataSource=metars.*format=XML/.test(xmlUrl), xmlUrl);
      } catch (e) { addTest('URL build throws', false, e.message); }

      try {
        // bbox order test lon_min,lat_min,lon_max,lat_max
        const lat = 31.14, lon = -97.71; const dLat = 50/60; const dLon = 50/(60*Math.cos(toRad(lat)));
        const box = `${(lon-dLon).toFixed(4)},${(lat-dLat).toFixed(4)},${(lon+dLon).toFixed(4)},${(lat+dLat).toFixed(4)}`;
        addTest('bbox order', /^-?\d+\.\d{4},\d+\.\d{4},-?\d+\.\d{4},\d+\.\d{4}$/.test(box), box);
      } catch (e) { addTest('bbox test throws', false, e.message); }

      try {
        const airportUrl = `${AWC_BASE}${AWC_PATH}/airport?ids=KHLR&format=json`;
        addTest('Airport URL', /^https:\/\/aviationweather\.gov\/api\/data\/airport\?ids=KHLR&format=json$/.test(airportUrl), airportUrl);
      } catch (e) { addTest('airport URL throws', false, e.message); }
    }

    async function fetchMetarXML() {
      const url = addsUrl({ dataSource: 'metars', requestType: 'retrieve', stationString: 'KHLR', format: 'XML', hoursBeforeNow: '6' });
      try {
        const xml = await fetchText(url);
        document.getElementById('xmlOut').textContent = xml;
      } catch (e) {
        document.getElementById('xmlOut').textContent = `Fetch error. ${e.message}. URL: ${url}`;
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', refreshAll);
    document.getElementById('xmlBtn').addEventListener('click', fetchMetarXML);
    startClock();
    runTests();
    refreshAll();
    setInterval(refreshAll, 5 * 60 * 1000);

    /*
      Note: Direct browser calls to aviationweather.gov may be subject to CORS. If blocked, route via your backend.
      NOTAMs still require your server at /faa/notams unless you provide a public FAA endpoint.
    */
  </script>
</body>
</html>
